import { Meta } from "@storybook/blocks";

<Meta title="Waveform Images API" />

# Waveform Images API (Experimental)

- Install with optional dependencies to use the waveform image API generation.
    - [`fluent-ffmpeg`](https://www.npmjs.com/package/fluent-ffmpeg) - Required for audio processing.
    - [`shelljs`](https://www.npmjs.com/package/shelljs) - Required for shell commands.

```bash
npm i @clxrity/react-audio --save-optional
```

> Note: Works only with the [Nextjs App Router](https://nextjs.org/docs/app) for generating the API route.

You can generate an image of an audio file's waveform by using the `setup-waveform-api` script.

```bash
npx setup-waveform-api
```

- This will create a new API route at `app/api/generate-waveform/route.ts`:

```ts
import fluentFfmpeg from 'fluent-ffmpeg';
import path from 'path';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(req: NextRequest) {
    const url = new URL(req.url);
    const audioUrl = url.searchParams.get('url');

    if (!audioUrl) {
        return NextResponse.json({ error: 'Missing URL query parameter' }, { status: 400 });
    }

    const waveformPath = path.join(process.cwd(), 'public', 'waveform.png');

    const promise = new Promise((resolve, reject) => {
        fluentFfmpeg(audioUrl)
        .audioFilters('aformat=channel_layouts=stereo')
        .outputOptions('-filter_complex', 'aformat=channel_layouts=stereo,showwavespic=s=600x120')
        .output(waveformPath)
        .on('end', () => {
            resolve(NextResponse.json({ message: `Waveform image at ${waveformPath}` }, { status: 200 }));
        })
        .on('error', (err) => {
            reject(NextResponse.json({ error: err }, { status: 500 }));
        })
        .run();
    });

    return promise;
}
```

- You can then use this route to generate the waveform image of an audio file:

```tsx
/**
 * In this example, the audio file is within the public/ directory.
 * `/public/audio.wav` = `http://localhost:3000/audio.wav`
 * @see https://nextjs.org/docs/app/building-your-application/optimizing/static-assets
 */
await fetch('http://localhost:3000/api/generate-waveform?url=http://localhost/audio.wav');
```

- This will generate a waveform image at `public/waveform.png`:

![Waveform Image](https://raw.githubusercontent.com/clxrityy/react-audio/main/src/stories/assets/waveform.png)

> Note: The waveform image is generated in the public/ directory and can be accessed at `http://localhost:3000/waveform.png`.


## Plans

The ideal plan is to serve the images asynchronously along with a component that can be used to display the audio through the waveform image. This will be done in the future releases.